<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Virtual Glasses Try-On (PNG + GLB)</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f4f4f4; margin: 0; }
    header { padding: 20px; }
    .camera-container { position: relative; display: inline-block; }
    video, canvas { border-radius: 10px; }
    #overlay { position: absolute; left: 0; top: 0; }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; }
    #three-container { display: none; margin: auto; }
  </style>
</head>
<body>
  <header>
    <h1>Virtual Glasses Try-On</h1>
    <p>Switch between PNG overlay and 3D GLB model</p>
  </header>

  <div class="controls">
    <button id="startBtn">üé• Start Camera</button>
    <button id="stopBtn" disabled>‚èπÔ∏è Stop Camera</button>
    <button id="toggleModeBtn">Switch to 3D GLB</button>
  </div>

  <div class="camera-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

  <div id="three-container" style="width:640px; height:480px;"></div>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

  <!-- Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/loaders/GLTFLoader.js"></script>

  <script>
    let faceMesh, camera, canvas, ctx;
    let glassesImg = new Image();
    glassesImg.src = "a2ec560f-b602-41d6-baa5-0241e9f78513.png"; // your PNG specs

    let is3DMode = false; // toggle state
    let scene, camera3D, renderer, glassesModel;

    async function init() {
      const video = document.getElementById('video');
      canvas = document.getElementById('overlay');
      ctx = canvas.getContext('2d');

      function resizeCanvas() {
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
      }

      faceMesh = new FaceMesh({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
      });

      faceMesh.setOptions({
        maxNumFaces: 1,
        refineLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });

      faceMesh.onResults(onResults);

      camera = new Camera(video, {
        onFrame: async () => {
          await faceMesh.send({ image: video });
        },
        width: 640,
        height: 480
      });

      document.getElementById("startBtn").onclick = async () => {
        await camera.start();
        resizeCanvas();
        document.getElementById("startBtn").disabled = true;
        document.getElementById("stopBtn").disabled = false;
      };

      document.getElementById("stopBtn").onclick = () => {
        camera.stop();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
      };

      document.getElementById("toggleModeBtn").onclick = () => {
        is3DMode = !is3DMode;
        document.getElementById("overlay").style.display = is3DMode ? "none" : "block";
        document.getElementById("three-container").style.display = is3DMode ? "block" : "none";
        document.getElementById("toggleModeBtn").innerText = is3DMode ? "Switch to PNG Overlay" : "Switch to 3D GLB";
      };

      window.addEventListener("resize", resizeCanvas);

      initThree(); // init 3D scene
      animateThree();
    }

    function onResults(results) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) return;
      const landmarks = results.multiFaceLandmarks[0];

      if (is3DMode) {
        updateGlasses3D(landmarks);
      } else {
        drawGlassesPNG(landmarks);
      }
    }

    // ---------------- PNG Overlay Mode ----------------
    function drawGlassesPNG(landmarks) {
      const leftEye = landmarks[33];
      const rightEye = landmarks[263];
      const nose = landmarks[168];

      const eyeDist = Math.sqrt(
        Math.pow((rightEye.x - leftEye.x) * canvas.width, 2) +
        Math.pow((rightEye.y - leftEye.y) * canvas.height, 2)
      );

      const centerX = ((leftEye.x + rightEye.x) / 2) * canvas.width;
      const centerY = ((leftEye.y + rightEye.y) / 2) * canvas.height;

      const dx = (rightEye.x - leftEye.x) * canvas.width;
      const dy = (rightEye.y - leftEye.y) * canvas.height;
      const rotation = Math.atan2(dy, dx);

      const scale = (eyeDist * 2.0) / 220; // adjust scaling
      const scaledWidth = 220 * scale;
      const scaledHeight = 65 * scale;

      ctx.save();
      ctx.translate(centerX, centerY + (nose.y * canvas.height - centerY) * 0.8);
      ctx.rotate(rotation);
      ctx.drawImage(glassesImg, -scaledWidth / 2, -scaledHeight / 2, scaledWidth, scaledHeight);
      ctx.restore();
    }

    // ---------------- 3D GLB Mode ----------------
    function initThree() {
      const container = document.getElementById('three-container');
      scene = new THREE.Scene();
      camera3D = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer({ alpha: true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      container.appendChild(renderer.domElement);

      const light = new THREE.HemisphereLight(0xffffff, 0x444444);
      light.position.set(0, 200, 0);
      scene.add(light);

      const loader = new THREE.GLTFLoader();
      loader.load("sun_glasses_fbx_346kb.glb", function(gltf) {
        glassesModel = gltf.scene;
        glassesModel.scale.set(0.01, 0.01, 0.01); // adjust to fit
        scene.add(glassesModel);
      });

      camera3D.position.z = 2;
    }

    function updateGlasses3D(landmarks) {
      if (!glassesModel) return;

      const leftEye = landmarks[33];
      const rightEye = landmarks[263];
      const nose = landmarks[168];

      const centerX = (leftEye.x + rightEye.x) / 2 - 0.5;
      const centerY = -(nose.y - 0.5);

      glassesModel.position.set(centerX, centerY, -1.5);

      const dx = rightEye.x - leftEye.x;
      const dy = rightEye.y - leftEye.y;
      const rotation = Math.atan2(dy, dx);
      glassesModel.rotation.set(0, 0, -rotation);
    }

    function animateThree() {
      requestAnimationFrame(animateThree);
      if (renderer && scene && camera3D) {
        renderer.render(scene, camera3D);
      }
    }

    window.onload = init;
  </script>
</body>
</html>
